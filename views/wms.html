<!DOCTYPE html>
<html>
    {% autoescape true %}
<head>
    <title>GIS Code Challenge - Extracting Bus <stops></stops></title>
    <meta name="keywords" content="GeoJSON Validation,GeoJSON Validator,GeoJSONLint,GeoJSON Lint,Validate GeoJSON">
    <meta name="description" content="Validate your GeoJSON and display it on a map.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js">
    <link href='//api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet'>
    <link rel="stylesheet" href="http://geojsonlint.com/static/css/app.css">
</head>
<body>
    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/busstops">Door2Door GIS Code Challenge</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div style="border: 1px solid white; float: left;">
            <div class="checkbox">
                <label><input type="checkbox" value="" onclick="ToggleRoutes();" checked>Routes</label>
            </div>
            <div class="checkbox">
                <label><input type="checkbox" value="" onclick="ToggleBusStops();" checked>Bus stops</label>
            </div>
        </div>
        <div id="input-output" class="row">
            <div class="col-sm-12 full-height">
                <div id="map-container" class="full-height"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <h3>Questions?</h3>
        <p>
            Read the <a href="https://github.com/manikanta-kondeti/gis-code-challenge/blob/master/README.md">blog post</a> or check out the <a href="https://github.com/manikanta-kondeti/gis-code-challenge">source code</a>.
        </p>
    </div>
    <div id="modal-message" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-message-header">Invalid JSON</h3>
                </div>
                <div class="modal-body">
                    <p id="modal-message-body"></p>
                </div>
                <div class="modal-footer">
                    <a id="modal-message-close" href="#" class="btn btn-default modal-close">Close</a>
                </div>
            </div>
        </div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src='//api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src="http://geojsonlint.com/static/js/geojsonhint.js"></script>
    <script src="http://geojsonlint.com/static/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="http://geojsonlint.com/static/js/sample-geojson.js"></script>
    <script>
              var map;
              var routes_data = {{ routes_json|safe }};
              var busstops_data = {{ busstops_json|safe }};
              var geojsonLayer;
              var Layers = [];
              var myStyle = {
                "color": "#ff7800",
                "weight": 2,
                "opacity": 0.65
              };

              function getGeojsonLayer() {
                 geojsonLayer = new L.GeoJSON(null, {
                   style: myStyle,
                   pointToLayer: function(feature, latlng) {
                     var smallIcon =  L.icon({
                      iconUrl: 'http://cliparts.co/cliparts/dT4/oLp/dT4oLp7Ec.svg',
                      iconRetinaUrl: 'http://cliparts.co/cliparts/dT4/oLp/dT4oLp7Ec.svg',
                      iconSize: [30, 50]
                     });
                     return L.marker(latlng, {icon: smallIcon});
                   },
                   onEachFeature: function (feature, layer) {
                    if (feature.properties) {
                      var popupString = '<div class="popup">';
                      for (var k in feature.properties) {
                        var v = feature.properties[k];
                        popupString += k + ': ' + v + '<br />';
                      }
                      popupString += '</div>';
                      layer.bindPopup(popupString, {
                        maxHeight: 200
                      });
                    }
                   }
                });
                return geojsonLayer;
              }

              $(document).ready(function() {

                L.mapbox.accessToken = 'pk.eyJ1IjoiamNzYW5mb3JkIiwiYSI6InRJMHZPZFUifQ.F4DMGoNgU3r2AWLY0Eni-w';
                map = L.mapbox.map('map-container', 'mapbox.streets')
                map.setView([37.92686, -96.76757], 4);

                geojsonLayer = getGeojsonLayer();
                geojsonLayer.addData(JSON.parse(busstops_data));
                geojsonLayer.addData(JSON.parse(routes_data));

                Layers.push(busstops_data);
                Layers.push(routes_data);

                map.fitBounds(geojsonLayer.getBounds());
                map.addLayer(geojsonLayer);

              });

              function ToggleBusStops() {
                    if (Layers.indexOf(busstops_data) != -1) {
                        index = Layers.indexOf(busstops_data);
                        Layers.splice(index, 1);
                        RemoveFromMap(busstops_data);
                        UpdateMap();
                    }
                    else {
                        Layers.push(busstops_data);
                        UpdateMap();
                    }
              }

              function ToggleRoutes() {
                    if (Layers.indexOf(routes_data) != -1) {
                        index = Layers.indexOf(routes_data);
                        Layers.splice(index, 1);
                        RemoveFromMap(routes_data);
                        UpdateMap();
                    }
                    else {
                        Layers.push(routes_data);
                        UpdateMap();
                    }
              }

              function UpdateMap() {
                console.log("Layers length " + Layers.length);
                geojsonLayer = getGeojsonLayer();
                for (var i=0; i<Layers.length; i++) {
                    geojsonLayer.addData(JSON.parse(Layers[i]));
                    map.fitBounds(geojsonLayer.getBounds());
                    map.addLayer(geojsonLayer);
                    //geojsonLayer = null;
                }
              }

              function RemoveFromMap(data) {
                    geojsonLayer.addData(JSON.parse(data));
                    map.removeLayer(geojsonLayer);
                    geojsonLayer = null;
                    console.log("Layers length " + Layers.length);
              }

    </script>
</body>
</html>
{% endautoescape %}